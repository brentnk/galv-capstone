<!DOCTYPE html>
<html>
<head>
    <title>L.D3SvgOverlay: Leaflet + D3, simple example</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        .wrapper { position: relative; min-height: 100%; }
        .searchbox { position: absolute;
          top:20px, left: 20px;
          padding-left: 60px;
          padding-top: 14px;
          z-index: 99;}
        #searchBox { font-size: xx-large }
        #map-canvas { height: 100vh }
    </style>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    	rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">

</head>
<body>
  <div class="wrapper">
    <div class="searchbox">
      <input id='searchBox' type="text" name="searchTerms"
        placeholder="chipotle;hardware store;etc..." onkeypress="handleSearch(event)">
    </div>
    <div id="map-canvas"></div>
  </div>
<script src="https://code.jquery.com/jquery-3.1.0.slim.min.js"   integrity="sha256-cRpWjoSOw5KcyIOaZNo4i6fZ9tKPhYYb6i5T9RSVJG8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
<script src="bower/leaflet-d3-svg-overlay/L.D3SvgOverlay.min.js"></script>
<script src="bower/leaflet-hexbin-2/dist/leaflet-hexbin.min.js"></script>
<script src="bower/d3-plugins/hexbin/hexbin.js"></script>
<script src="bower/underscore/underscore-min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-scale.v1.min.js"></script>
<script>
function handleSearch(e) {
  if(e.keyCode === 13) {
    var term = document.getElementById('searchBox')
    console.log('handleSearch() ' + term.value)
    searchTerms(term.value)
    term.value = ''
  }
}

var map = L.map("map-canvas",{center:[39.7047, -105.0814],zoom:11});
L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',{ attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://cartodb.com/attributions">CartoDB</a>' }).addTo(map);

var options = {
  radiusRange: [7,7],
  radius: 7,
  opacity: 0.47,
  lng: function(d){ return d[1]; },
  lat: function(d){ return d[2]; },
  value: pdfCounter,
  valueFloor: 0,
  valueCeil: undefined
}

var hexOverlay = L.hexbinLayer(options).addTo(map);


var poi = [];
var poiOverlay = L.d3SvgOverlay(function(sel, proj) {

  console.log(proj.scale)
  var poiUpd = sel.selectAll('circle').data(poi)
    .enter()
    .append('circle')
    .attr('r',function(d){return 3.0 / proj.scale})
    .attr('cx',function(d){return proj.latLngToLayerPoint(d.slice(1).reverse()).x;})
    .attr('cy',function(d){return proj.latLngToLayerPoint(d.slice(1).reverse()).y;})
    .attr('stroke','#E76F51')
    .attr('stroke-width',.2)
    .attr('fill', '#2A9D8F')
    .attr('fill-opacity', .37)
}, {zoomDraw:true})

function uniqueCellCounter(d){
  // console.log(d);
  var s = d.reduce(function(a, b){
    return a.add(b.d[0])},
    new Set()).size;
  return s;
}

function sumCellCounter(d) {
  return d.length;
}

function logSumCellCounter(d) {
  // console.log(Math.log(d.length));
  return 10.0 * Math.log(d.length);
}

function pdfCounter(d) {
  return d.length;
}



function searchTerms(terms) {
  d3.json('/api/radar/' + terms, function(data) {
    console.log(data)
    data.terms.forEach( function(term) {
      poi = poi.concat(data[term]);
    });

    hexOverlay.colorScale(d3.scaleSequential(d3.interpolateViridis))
    hexOverlay.data(poi)
  });
}



</script>

</body>
</html>
