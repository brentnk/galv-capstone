<!DOCTYPE html>
<html>
<head>
    <title>L.D3SvgOverlay: Leaflet + D3, simple example</title>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
    </style>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css'
    	rel='stylesheet' type='text/css'/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">

</head>
<body>
  <div class="searchbox"></div>
  <div id="map-canvas"></div>
<script src="https://code.jquery.com/jquery-3.1.0.slim.min.js"   integrity="sha256-cRpWjoSOw5KcyIOaZNo4i6fZ9tKPhYYb6i5T9RSVJG8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
<script src="js/L.D3SvgOverlay.min.js"></script>
<script>


var map = L.map("map-canvas",{center:[39.7047, -105.0814],zoom:11});
L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

var cities = [];
var citiesOverlay = L.d3SvgOverlay(function(sel,proj){

  var minLogPop = Math.log2(d3.min(cities,function(d){return d.population;}));
  var citiesUpd = sel.selectAll('circle').data(cities);
  citiesUpd.enter()
    .append('circle')
    .attr('r',function(d){return Math.log2(d.population) - minLogPop + 2;})
    .attr('cx',function(d){return proj.latLngToLayerPoint(d.latLng).x;})
    .attr('cy',function(d){return proj.latLngToLayerPoint(d.latLng).y;})
    .attr('stroke','black')
    .attr('stroke-width',1)
    .attr('fill',function(d){return (d.place == 'city') ? "red" : "blue";});
});

var poi = {};
var poiOverlay = L.d3SvgOverlay(function(sel, proj) {

  console.log(proj.scale)
  var poiUpd = sel.selectAll('circle').data(poi)
    .enter()
    .append('circle')
    .attr('r',function(d){return 3.0 / proj.scale})
    .attr('cx',function(d){return proj.latLngToLayerPoint(d.slice(1).reverse()).x;})
    .attr('cy',function(d){return proj.latLngToLayerPoint(d.slice(1).reverse()).y;})
    .attr('stroke','#E76F51')
    .attr('stroke-width',.2)
    .attr('fill', '#2A9D8F')
    .attr('fill-opacity', .37)
}, {zoomDraw:true})

d3.json('/api/radar/chipotle', function(data) {
  poi = data.chipotle
  poiOverlay.addTo(map)
})

// d3.csv("data/swiss-cities.csv",function(data){
//   cities = data.map(function(d){
//     d.latLng = [+d.lat,+d.lng];
//     d.population = (d.population == '') ? 2000 : +d.population; //NAs
//     return d;
//   });
//   citiesOverlay.addTo(map);
// });


</script>

</body>
</html>
